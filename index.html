<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="index.css">
    <title>Dashboard Recuperação</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Koulen&family=Poppins:wght@300;400;500;600;700;800&display=swap');
        select {
            color: var(--color-dark-variant);
            background-color: var(--color-light);
            border: 1px solid var(--color-dark-variant);
        }

        select option {
            color: var(--color-dark);
        }

        @media screen and (max-width: 768px) {
            .container {
                width: 100%;
                padding: 10px;
            }

            .controls {
                flex-direction: column;
                gap: 15px;
            }

            .date,
            .tabs {
                flex-direction: column;
                width: 100%;
            }

            .metric {
                width: 100%;
                margin-bottom: 20px;
            }

            .recent-orders table {
                font-size: 0.8rem;
            }
        }
    </style>
</head>
<body>
    <div class="container" style="max-width: 1200px; margin: 0 auto; padding: 20px;">
        <main>
            <h1 style="color: var(--color-primary); font-size: 2rem; font-weight: 800;">Painel de recuperação</h1>

            <div class="controls" style="display: flex; justify-content: space-between; margin-bottom: 20px;">
                <div class="date" style="display: flex; align-items: center; gap: 20px;">
                    <label for="data_inicio" style="color: var(--color-dark); font-size: 1rem;">Data Início:</label>
                    <input type="date" id="data_inicio" style="border-radius: 4px; padding: 5px;">
                    <label for="data_fim" style="color: var(--color-dark); font-size: 1rem;">Data Fim:</label>
                    <input type="date" id="data_fim" style="border-radius: 4px; padding: 5px;">
                </div>

                <div class="tabs" style="display: flex; gap: 10px;">
                    <label for="status_filtro" style="color: var(--color-dark); font-size: 1rem;">Status:</label>
                    <select id="status_filtro" onchange="updateDashboard()" style="padding: 8px; border-radius: 4px; background-color: black;">
                        <option value="todos">Pendente</option>
                        <option value="recuperado">Recuperado</option>
                    </select>
                </div>

                <button class="confirm-btn" id="confirmar" onclick="updateDashboard()" style="background-color: var(--color-primary); color: var(--color-white); padding: 10px 20px; border-radius: 5px; font-size: 1rem; cursor: pointer;">Confirmar</button>
            </div>

            <div class="insights" style="display: flex; justify-content: space-between; margin-bottom: 30px;">
                <div class="metric" style="background-color: var(--color-white); padding: 20px; border-radius: var(--card-border-radius); box-shadow: var(--box-shadow); width: 30%; text-align: center;">
                    <h3 style="color: var(--color-dark);">Carrinhos abandonados</h3>
                    <h1 class="carrinhos-abandonados" style="color: var(--color-primary); font-size: 2rem;">0</h1>
                </div>
                <div class="metric" style="background-color: var(--color-white); padding: 20px; border-radius: var(--card-border-radius); box-shadow: var(--box-shadow); width: 30%; text-align: center;">
                    <h3 style="color: var(--color-dark);">Vendas recuperadas</h3>
                    <h1 class="vendas-recuperadas" style="color: var(--color-primary); font-size: 2rem;">0</h1>
                </div>
                <div class="metric" style="background-color: var(--color-white); padding: 20px; border-radius: var(--card-border-radius); box-shadow: var(--box-shadow); width: 30%; text-align: center;">
                    <h3 style="color: var(--color-dark);">Dinheiro recuperado</h3>
                    <h1 class="dinheiro-recuperado" style="color: var(--color-primary); font-size: 2rem;">R$0.00</h1>
                </div>
            </div>

            <div class="insights" style="display: flex; justify-content: space-between; margin-bottom: 30px;">
                <div class="metric" style="background-color: var(--color-white); padding: 20px; border-radius: var(--card-border-radius); box-shadow: var(--box-shadow); width: 30%; text-align: center;">
                    <h3 style="color: var(--color-dark);">Taxa de Recuperação</h3>
                    <h1 id="taxaRecuperacao" style="color: var(--color-primary); font-size: 2rem;">0%</h1>
                </div>
                <div class="metric" style="background-color: var(--color-white); padding: 20px; border-radius: var(--card-border-radius); box-shadow: var(--box-shadow); width: 30%; text-align: center;">
                    <h3 style="color: var(--color-dark);">Valor Médio por Recuperação</h3>
                    <h1 id="valorMedioRecuperacao" style="color: var(--color-primary); font-size: 2rem;">R$0.00</h1>
                </div>
                <div class="metric" style="background-color: var(--color-white); padding: 20px; border-radius: var(--card-border-radius); box-shadow: var(--box-shadow); width: 30%; text-align: center;">
                    <h3 style="color: var(--color-dark);">Tempo Médio de Recuperação</h3>
                    <h1 id="tempoMedioRecuperacao" style="color: var(--color-primary); font-size: 2rem;">0 dias</h1>
                </div>
            </div>

            <div class="recent-orders" style="background-color: var(--color-white); padding: 20px; border-radius: var(--card-border-radius); box-shadow: var(--box-shadow);">
                <h2 style="color: var(--color-primary); margin-bottom: 20px;">Pedidos Recentes</h2>
                <table style="width: 100%; text-align: left; border-collapse: collapse;">
                    <thead>
                        <tr>
                            <th style="padding: 10px; border-bottom: 1px solid var(--color-light);">Nome do cliente</th>
                            <th style="padding: 10px; border-bottom: 1px solid var(--color-light);">Data</th>
                            <th style="padding: 10px; border-bottom: 1px solid var(--color-light);">Código Pagamento</th>
                            <th style="padding: 10px; border-bottom: 1px solid var(--color-light);">Status</th>
                            <th style="padding: 10px; border-bottom: 1px solid var(--color-light);">Ações</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
                <a href="#" style="color: var(--color-primary); text-align: center; display: block; margin-top: 20px;" onclick="loadMoreData()">Mostrar mais</a>
            </div>

            <div class="action-history" style="background-color: var(--color-white); padding: 20px; border-radius: var(--card-border-radius); box-shadow: var(--box-shadow); margin-top: 30px;">
                <h3 style="color: var(--color-dark);">Histórico de Ações</h3>
                <ul id="actionLog" style="margin-top: 20px;"></ul>
            </div>

            <button id="exportarCSV" style="background-color: var(--color-primary); color: var(--color-white); padding: 10px 20px; border-radius: 5px; margin-top: 30px; cursor: pointer;">Exportar CSV</button>
        </main>

        <div class="right" style="margin-top: 30px;">
            <!-- <div class="top" style="display: flex; justify-content: flex-end; gap: 20px;">
                <div class="themeToggler" style="background-color: var(--color-light); padding: 5px; border-radius: 5px; display: flex; align-items: center; cursor: pointer;">
                    <span id="lightMode" class="material-symbols-sharp active" style="padding: 5px; cursor: pointer;">light_mode</span>
                    <span id="darkMode" class="material-symbols-sharp" style="padding: 5px; cursor: pointer;">dark_mode</span>
                </div> -->
            </div>
        </div>
    </div>

    <script src="index.js"></script>
    <script>
        let vendasData = [];
        let currentOffset = 0;

        function formatDateBR(dateStr) {
            if (!dateStr) return 'N/A';
            const date = new Date(dateStr);
            return date.toLocaleDateString('pt-BR');
        }

        function compareDates(a, b) {
            const dateA = new Date(a);
            const dateB = new Date(b);
            return dateB - dateA;
        }

        function formatCurrency(value) {
            return value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        }

        document.addEventListener('DOMContentLoaded', () => {
            const today = new Date();
            const firstDay = new Date(today.getFullYear(), today.getMonth(), 1).toISOString().split('T')[0];
            const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0).toISOString().split('T')[0];

            document.querySelector('#data_inicio').value = firstDay;
            document.querySelector('#data_fim').value = lastDay;

            updateDashboard(firstDay, lastDay);
        });

        async function updateDashboard(dataInicio = null, dataFim = null) {
            try {
                if (!dataInicio || !dataFim) {
                    dataInicio = document.querySelector('#data_inicio').value;
                    dataFim = document.querySelector('#data_fim').value;
                }

                const statusFiltro = document.querySelector('#status_filtro').value;

                let statusResponse = await fetch(`https://recuperacao-3e9d5efa7a2e.herokuapp.com/dashboard?day_start=${dataInicio.split('-')[2]}&day_end=${dataFim.split('-')[2]}&month=${dataInicio.split('-')[1]}&year=${dataInicio.split('-')[0]}`);
                let statusData = await statusResponse.json();

                document.querySelector('.carrinhos-abandonados').textContent = statusData.carrinhos_abandonados;
                document.querySelector('.vendas-recuperadas').textContent = statusData.vendas_recuperadas;
                document.querySelector('.dinheiro-recuperado').textContent = formatCurrency(statusData.total_dinheiro_recuperado);

                let vendasResponse = await fetch(`https://recuperacao-3e9d5efa7a2e.herokuapp.com/vendas-pendentes?day_start=${dataInicio.split('-')[2]}&day_end=${dataFim.split('-')[2]}&month=${dataInicio.split('-')[1]}&year=${dataInicio.split('-')[0]}`);
                vendasData = await vendasResponse.json();

                if (statusFiltro !== 'todos') {
                    vendasData = vendasData.filter(venda => venda.status === statusFiltro);
                }

                vendasData.sort((a, b) => {
                    let dataA = a.status === 'recuperado' ? a.data_recuperacao : a.data_abandono;
                    let dataB = b.status === 'recuperado' ? b.data_recuperacao : b.data_abandono;
                    return compareDates(dataA, dataB);
                });

                document.querySelector('.recent-orders tbody').innerHTML = '';
                currentOffset = 0;
                loadMoreData();

                updateKPIs(statusData);
            } catch (error) {
                console.error('Erro ao atualizar o dashboard:', error);
            }
        }

        function renderTableData(startIndex, endIndex) {
            let tabelaVendas = document.querySelector('.recent-orders tbody');

            for (let i = startIndex; i < endIndex && i < vendasData.length; i++) {
                let venda = vendasData[i];
                let statusClass = venda.status === 'recuperado' ? 'primary' : 'danger';
                let statusLabel = venda.status === 'recuperado' ? 'Pago' : 'Pendente';

                let data = venda.status === 'recuperado' ? venda.data_recuperacao : venda.data_abandono;
                let dataFormatada = formatDateBR(data);

                let row = `
                    <tr>
                        <td>${venda.full_name}</td>
                        <td>${dataFormatada}</td>
                        <td>${venda.transaction_id}</td>
                        <td class="${statusClass}">${statusLabel}</td>
                        <td></td>
                    </tr>
                `;
                tabelaVendas.insertAdjacentHTML('beforeend', row);
            }
        }

        function loadMoreData() {
            let startIndex = currentOffset;
            let endIndex = currentOffset + 30;
            renderTableData(startIndex, endIndex);
            currentOffset = endIndex;

            if (currentOffset >= vendasData.length) {
                document.querySelector('.recent-orders a').style.display = 'none';
            }
        }

        function updateKPIs(statusData) {
            const taxaRecuperacao = (statusData.vendas_recuperadas / statusData.carrinhos_abandonados) * 100;
            document.querySelector('#taxaRecuperacao').textContent = taxaRecuperacao.toFixed(2) + '%';

            const valorMedioRecuperacao = statusData.total_dinheiro_recuperado / statusData.vendas_recuperada;
            document.querySelector('#valorMedioRecuperacao').textContent = formatCurrency(valorMedioRecuperacao);

            const tempoMedioRecuperacao = statusData.tempo_medio_recuperacao;
            const diasInteiros = Math.floor(tempoMedioRecuperacao);
            const horas = Math.round((tempoMedioRecuperacao - diasInteiros) * 24);

            let displayTempoRecuperacao;
            if (diasInteiros > 0) {
                displayTempoRecuperacao = `${diasInteiros} dias`;
            } else {
                displayTempoRecuperacao = `${horas} horas`;
            }

            document.querySelector('#tempoMedioRecuperacao').textContent = displayTempoRecuperacao;
        }

        function exportToCSV() {
            const rows = [['Nome do Cliente', 'Data', 'Código Pagamento', 'Status']];
            vendasData.forEach(venda => {
                rows.push([venda.full_name, venda.data_abandono || venda.data_recuperacao, venda.transaction_id, venda.status]);
            });

            let csvContent = 'data:text/csv;charset=utf-8,';
            rows.forEach(row => {
                csvContent += row.join(',') + '\n';
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement('a');
            link.setAttribute('href', encodedUri);
            link.setAttribute('download', 'vendas_recuperacao.csv');
            document.body.appendChild(link);
            link.click();
        }

        document.querySelector('#exportarCSV').addEventListener('click', exportToCSV);

        document.querySelector('#darkMode').addEventListener('click', () => {
            document.body.classList.add('dark-theme');
        });
        document.querySelector('#lightMode').addEventListener('click', () => {
            document.body.classList.remove('dark-theme');
        });

        document.querySelector('.recent-orders a').addEventListener('click', loadMoreData);
    </script>
</body>
</html>
