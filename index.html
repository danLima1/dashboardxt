<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
    <title>Vendas Dashboard</title>
</head>
<body>
    <!-- Seletores de período (Mês e Ano) -->
    <div class="period-selector">
        <label for="month">Mês:</label>
        <select id="month">
            <option value="1">Janeiro</option>
            <option value="2">Fevereiro</option>
            <option value="3">Março</option>
            <option value="4">Abril</option>
            <option value="5">Maio</option>
            <option value="6">Junho</option>
            <option value="7">Julho</option>
            <option value="8">Agosto</option>
            <option value="9">Setembro</option>
            <option value="10">Outubro</option>
            <option value="11">Novembro</option>
            <option value="12">Dezembro</option>
        </select>

        <label for="year">Ano:</label>
        <select id="year">
            <!-- As opções de ano serão geradas dinamicamente -->
        </select>

        <button onclick="updateDashboard()">Aplicar</button>
    </div>

    <div class="status">
        <h1 class="title">Status</h1>
        <div style="background: #ff7700;" class="option">
            <h1>Carrinhos Abandonados</h1>
            <h2 id="carrinhos_abandonados">...</h2>
        </div>
        <div style="background: #0702ff;" class="option">
            <h1>Vendas Recuperadas</h1>
            <h2 id="vendas_recuperadas">...</h2>
        </div>
        <div style="background: #fb02ff;" class="option">
            <h1>Dinheiro recuperado</h1>
            <h2 id="total_dinheiro_recuperado">...</h2>
        </div>
    </div>

    <div class="pendentes">
        <div class="anuncio">
            <h1 class="title">Vendas Pendentes</h1>
        </div>
        <div id='vendas_pendentes' class="vendas">
            <!-- Informações das vendas pendentes aparecerão aqui -->
        </div>
    </div>

    <script>
        // Define o mês e ano atuais nos seletores
        document.addEventListener('DOMContentLoaded', () => {
            const monthSelect = document.getElementById('month');
            const yearSelect = document.getElementById('year');
            
            const currentDate = new Date();
            const currentMonth = currentDate.getMonth() + 1; // getMonth() retorna 0 para janeiro
            const currentYear = currentDate.getFullYear(); // Obtém o ano atual

            // Define o mês atual como selecionado
            monthSelect.value = currentMonth;

            // Adiciona os anos ao seletor e define o ano atual
            yearSelect.innerHTML = ''; // Limpa opções existentes
            for (let year = currentYear - 1; year <= currentYear + 1; year++) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                yearSelect.appendChild(option);
            }
            yearSelect.value = currentYear; // Define o ano atual como selecionado
        });

        // Atualiza os dados no dashboard e vendas pendentes
        async function updateDashboard() {
            try {
                const month = document.getElementById('month').value;
                const year = document.getElementById('year').value;

                // Atualizar status dos carrinhos abandonados, vendas recuperadas e dinheiro recuperado com base no mês/ano
                let statusResponse = await fetch(`https://recuperacao-3e9d5efa7a2e.herokuapp.com/dashboard?month=${month}&year=${year}`);
                let statusData = await statusResponse.json();

                document.getElementById('carrinhos_abandonados').textContent = statusData.carrinhos_abandonados;
                document.getElementById('vendas_recuperadas').textContent = statusData.vendas_recuperadas;
                document.getElementById('total_dinheiro_recuperado').textContent = `R$ ${statusData.total_dinheiro_recuperado.toFixed(2)}`;

                // Atualizar vendas pendentes com base no mês/ano
                let vendasResponse = await fetch(`https://recuperacao-3e9d5efa7a2e.herokuapp.com/vendas-pendentes?month=${month}&year=${year}`);
                let vendasData = await vendasResponse.json();

                let vendasPendentesDiv = document.getElementById('vendas_pendentes');
                vendasPendentesDiv.innerHTML = '';

                vendasData.forEach(venda => {
                    let vendaDiv = document.createElement('div');
                    vendaDiv.className = 'venda';

                    let statusClass = venda.status === 'recuperado' ? 'status-pago' : 'status-pendente';
                    let statusLabel = venda.status === 'recuperado' ? 'Pago' : 'Pendente';

                    vendaDiv.innerHTML = `
                        <div class="venda-info">
                            <p><strong>${venda.full_name}</strong> está interessado em </p>
                            <p class="venda-produto">${venda.produto}</p>
                        </div>
                        <p class="venda-valor">Valor do produto: R$${venda.valor.toFixed(2)}</p>
                        <button class="${statusClass}">${statusLabel}</button>
                    `;

                    vendasPendentesDiv.appendChild(vendaDiv);
                });

            } catch (error) {
                console.error('Erro ao atualizar o dashboard:', error);
            }
        }

        // Atualizar o dashboard e vendas pendentes a cada 10 segundos (com mês/ano atuais)
        setInterval(updateDashboard, 10000);
        updateDashboard();
    </script>
</body>
</html>
