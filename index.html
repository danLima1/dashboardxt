<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!--STYLESHEET-->
    <link rel="stylesheet" href="index.css">
    <!--MATERIAL ICONS-->
    <link rel="stylesheet" href="https://fonts.sandbox.google.com/css2?family=Material+Symbols+Sharp:opsz,wght,FILL,GRAD@48,400,0,0"/>
    <title>Dashboard recuperação</title>
</head>
<body>
    <div class="container">
        <main>
            <h1>Painel de recuperação</h1>

            <div class="date">
                <!-- Adicionando dois campos de data: data de início e data de fim -->
                <label for="data_inicio">Data Início:</label>
                <input type="date" id="data_inicio">

                <label for="data_fim">Data Fim:</label>
                <input type="date" id="data_fim">

                <!-- Botão para confirmar a seleção de datas -->
                <button id="confirmar" onclick="updateDashboard()">Confirmar</button>
            </div>

            <!-- Adicionando a aba de "Recuperados" -->
            <div class="tabs">
                <button id="all-orders-btn" class="tab-btn active" onclick="updateDashboard()">Todos os Pedidos</button>
                <button id="recuperados-btn" class="tab-btn" onclick="updateRecuperados()">Recuperados</button>
            </div>

            <div class="insights">
                <div class="sales">
                    <span class="material-symbols-sharp">
                        analytics
                    </span>
                    <div class="middle">
                       <div class="left">
                            <h3>Carrinhos abandonados</h3>
                            <h1></h1>
                       </div> 
                       <div class="progress"></div>
                    </div>
                </div>
                <div class="expenses">
                    <span class="material-symbols-sharp">
                        bar_chart
                    </span>
                    <div class="middle">
                        <div class="left">
                            <h3>Vendas recuperadas</h3>
                            <h1></h1>
                        </div>
                        <div class="progress"></div>
                    </div>
                </div>
                <div class="income">
                    <span class="material-symbols-sharp">
                        stacked_line_chart
                    </span>
                    <div class="middle">
                        <div class="left">
                            <h3>Dinheiro recuperado</h3>
                            <h1>R$0.00</h1>
                        </div>
                        <div class="progress"></div>
                    </div>
                </div>
            </div>
            
            <div class="recent-orders">
                <table>
                    <thead>
                        <tr>
                            <th>Nome do cliente</th>
                            <th>Data</th>
                            <th>Código Pagamento</th>
                            <th>Status</th>
                            <th>Ações</th> <!-- Adicionado -->
                        </tr>
                    </thead>

                    <tbody>
                        <!-- Os dados serão atualizados dinamicamente pelo JavaScript -->
                    </tbody>
                </table>
                <a href="#">Mostrar mais</a>
            </div>
        </main>
        
        <div class="right">
            <div class="top">
                <button id="menu-btn">
                    <span class="material-symbols-sharp">
                        menu
                    </span>
                </button>
                <div class="themeToggler">
                    <span class="material-symbols-sharp active">
                        light_mode
                    </span>
                    <span class="material-symbols-sharp">
                        dark_mode
                    </span>
                </div>
            </div>
        </div>
    </div>

    <!-- Seus scripts -->
    <script src = "index.js"></script>
<script>
    let vendasData = []; // Armazena os dados de vendas
    let currentOffset = 0; // Controle da quantidade de itens exibidos

    // Função para formatar a data no padrão brasileiro (dd/mm/yyyy)
    function formatDateBR(dateStr) {
        if (!dateStr) return 'N/A';
        const date = new Date(dateStr);
        return date.toLocaleDateString('pt-BR');
    }

    // Função para comparar duas datas, usada para ordenar cronologicamente
    function compareDates(a, b) {
        const dateA = new Date(a);
        const dateB = new Date(b);
        return dateB - dateA; // Ordem decrescente, mais recente primeiro
    }

    // Carregar dados ao abrir a página com a data atual do mês
    document.addEventListener('DOMContentLoaded', () => {
        const today = new Date();
        const firstDay = new Date(today.getFullYear(), today.getMonth(), 1).toISOString().split('T')[0];
        const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0).toISOString().split('T')[0];

        document.querySelector('#data_inicio').value = firstDay;
        document.querySelector('#data_fim').value = lastDay;

        updateDashboard(firstDay, lastDay);
    });

    // Função para formatar valores em moeda brasileira
    function formatCurrency(value) {
        return value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
    }

    // Função para carregar e exibir os dados da tabela, controlando a exibição de 30 itens por vez
    function renderTableData(startIndex, endIndex) {
        let tabelaVendas = document.querySelector('.recent-orders tbody');
        for (let i = startIndex; i < endIndex && i < vendasData.length; i++) {
            let venda = vendasData[i];
            let statusClass = venda.status === 'recuperado' ? 'primary' : 'danger';
            let statusLabel = venda.status === 'recuperado' ? 'Pago' : 'Pendente';

            // Exibir apenas pedidos que não foram pagos na aba "Todos os Pedidos"
            if (statusLabel === 'Pago') continue;

            let data = venda.status === 'recuperado' ? venda.data_recuperacao : venda.data_abandono;
            let dataFormatada = formatDateBR(data); // Formatar data no padrão brasileiro

            let row = `
                <tr>
                    <td>${venda.full_name}</td>
                    <td>${dataFormatada}</td>
                    <td>${venda.transaction_id}</td>
                    <td class="${statusClass}">${statusLabel}</td>
                    <td></td> <!-- Ações omitidas se o status for Pago -->
                </tr>
            `;
            tabelaVendas.insertAdjacentHTML('beforeend', row);
        }
    }

    // Função para carregar mais itens ao clicar em "Ver Mais"
    function loadMoreData() {
        let startIndex = currentOffset;
        let endIndex = currentOffset + 30;
        renderTableData(startIndex, endIndex);
        currentOffset = endIndex;

        // Se não houver mais dados para exibir, esconder o botão "Ver Mais"
        if (currentOffset >= vendasData.length) {
            document.querySelector('.recent-orders a').style.display = 'none';
        }
    }

    // Atualizar dashboard com base no intervalo de datas selecionado
    async function updateDashboard(dataInicio = null, dataFim = null) {
        try {
            // Se não foram passadas as datas, usar as do input
            if (!dataInicio || !dataFim) {
                dataInicio = document.querySelector('#data_inicio').value;
                dataFim = document.querySelector('#data_fim').value;
            }

            // Buscar dados do status (carrinhos abandonados, vendas recuperadas, dinheiro recuperado)
            let statusResponse = await fetch(`https://recuperacao-3e9d5efa7a2e.herokuapp.com/dashboard?day_start=${dataInicio.split('-')[2]}&day_end=${dataFim.split('-')[2]}&month=${dataInicio.split('-')[1]}&year=${dataInicio.split('-')[0]}`);
            let statusData = await statusResponse.json();

            // Atualizar o campo de carrinhos abandonados
            document.querySelector('.sales h1').textContent = statusData.carrinhos_abandonados;

            // Atualizar o campo de vendas recuperadas
            document.querySelector('.expenses h1').textContent = statusData.vendas_recuperadas;

            // Atualizar o campo de dinheiro recuperado com formatação de moeda
            document.querySelector('.income h1').textContent = formatCurrency(statusData.total_dinheiro_recuperado);

            // Buscar dados das vendas pendentes e atualizar tabela
            let vendasResponse = await fetch(`https://recuperacao-3e9d5efa7a2e.herokuapp.com/vendas-pendentes?day_start=${dataInicio.split('-')[2]}&day_end=${dataFim.split('-')[2]}&month=${dataInicio.split('-')[1]}&year=${dataInicio.split('-')[0]}`);
            vendasData = await vendasResponse.json();

            // Ordenar os dados pela data (recuperação ou abandono) mais recente primeiro
            vendasData.sort((a, b) => {
                let dataA = a.status === 'recuperado' ? a.data_recuperacao : a.data_abandono;
                let dataB = b.status === 'recuperado' ? b.data_recuperacao : b.data_abandono;
                return compareDates(dataA, dataB);
            });

            // Resetar a tabela e carregar os primeiros 30 itens
            document.querySelector('.recent-orders tbody').innerHTML = '';
            currentOffset = 0;
            loadMoreData();

        } catch (error) {
            console.error('Erro ao atualizar o dashboard:', error);
        }
    }

    // Função para exibir apenas os pedidos recuperados
    async function updateRecuperados() {
        try {
            // Reaproveitar as mesmas datas do input
            let dataInicio = document.querySelector('#data_inicio').value;
            let dataFim = document.querySelector('#data_fim').value;

            // Buscar dados das vendas pendentes
            let vendasResponse = await fetch(`https://recuperacao-3e9d5efa7a2e.herokuapp.com/vendas-pendentes?day_start=${dataInicio.split('-')[2]}&day_end=${dataFim.split('-')[2]}&month=${dataInicio.split('-')[1]}&year=${dataInicio.split('-')[0]}`);
            let vendasData = await vendasResponse.json();

            // Filtrar apenas os recuperados
            let recuperadosData = vendasData.filter(venda => venda.status === 'recuperado');

            // Ordenar os dados por data de recuperação (mais recente primeiro)
            recuperadosData.sort((a, b) => compareDates(a.data_recuperacao, b.data_recuperacao));

            let tabelaVendas = document.querySelector('.recent-orders tbody');
            tabelaVendas.innerHTML = '';

            recuperadosData.forEach(venda => {
                let dataFormatada = formatDateBR(venda.data_recuperacao);
                let row = `
                    <tr>
                        <td>${venda.full_name}</td>
                        <td>${dataFormatada}</td>
                        <td>${venda.transaction_id}</td>
                        <td class="primary">Pago</td> <!-- Status sempre "Pago" -->
                        <td></td> <!-- Sem ações para pedidos já recuperados -->
                    </tr>
                `;
                tabelaVendas.insertAdjacentHTML('beforeend', row);
            });

        } catch (error) {
            console.error('Erro ao atualizar os recuperados:', error);
        }
    }

    // Adicionar event listener ao botão "Ver Mais"
    document.querySelector('.recent-orders a').addEventListener('click', loadMoreData);
</script>

</body>
</html>
